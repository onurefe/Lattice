#include "polyreg.h"
#include "matrix.h"

/* Private variables -------------------------------------------------------*/
// Polynomial fitting Matrix (X^T * X)^-1 X^T from degree 2, 100 samples with equal intervals
//from 1.8 to 2.2. Generated with the python script.
static const float Deg2Sa100From1d8to2d2[CALIBRATION_NUM_OF_SAMPLES * (CALIBRATION_POLY_DEGREE + 1)] =
    {
        7.54805475e+00, 7.10319214e+00, 6.66728603e+00,
        6.24033640e+00, 5.82234327e+00, 5.41330663e+00,
        5.01322647e+00, 4.62210281e+00, 4.23993563e+00,
        3.86672495e+00, 3.50247075e+00, 3.14717305e+00,
        2.80083183e+00, 2.46344711e+00, 2.13501887e+00,
        1.81554713e+00, 1.50503187e+00, 1.20347310e+00,
        9.10870829e-01, 6.27225043e-01, 3.52535747e-01,
        8.68029408e-02, -1.69973375e-01, -4.17793202e-01,
        -6.56656538e-01, -8.86563385e-01, -1.10751374e+00,
        -1.31950761e+00, -1.52254499e+00, -1.71662587e+00,
        -1.90175027e+00, -2.07791818e+00, -2.24512959e+00,
        -2.40338452e+00, -2.55268296e+00, -2.69302491e+00,
        -2.82441037e+00, -2.94683933e+00, -3.06031181e+00,
        -3.16482780e+00, -3.26038730e+00, -3.34699031e+00,
        -3.42463682e+00, -3.49332685e+00, -3.55306039e+00,
        -3.60383744e+00, -3.64565800e+00, -3.67852207e+00,
        -3.70242965e+00, -3.71738074e+00, -3.72337534e+00,
        -3.72041345e+00, -3.70849507e+00, -3.68762020e+00,
        -3.65778884e+00, -3.61900099e+00, -3.57125665e+00,
        -3.51455582e+00, -3.44889850e+00, -3.37428469e+00,
        -3.29071439e+00, -3.19818760e+00, -3.09670432e+00,
        -2.98626455e+00, -2.86686829e+00, -2.73851554e+00,
        -2.60120630e+00, -2.45494058e+00, -2.29971836e+00,
        -2.13553965e+00, -1.96240445e+00, -1.78031276e+00,
        -1.58926458e+00, -1.38925992e+00, -1.18029876e+00,
        -9.62381111e-01, -7.35506973e-01, -4.99676346e-01,
        -2.54889228e-01, -1.14562118e-03, 2.61554476e-01,
        5.33211063e-01, 8.13824140e-01, 1.10339371e+00,
        1.40191976e+00, 1.70940231e+00, 2.02584135e+00,
        2.35123687e+00, 2.68558889e+00, 3.02889739e+00,
        3.38116239e+00, 3.74238388e+00, 4.11256185e+00,
        4.49169632e+00, 4.87978727e+00, 5.27683472e+00,
        5.68283865e+00, 6.09779908e+00, 6.52171599e+00,
        6.95458940e+00,
        -7.42137449e+00, -6.97759482e+00, -6.54281064e+00,
        -6.11702197e+00, -5.70022879e+00, -5.29243110e+00,
        -4.89362892e+00, -4.50382223e+00, -4.12301104e+00,
        -3.75119535e+00, -3.38837515e+00, -3.03455045e+00,
        -2.68972125e+00, -2.35388755e+00, -2.02704934e+00,
        -1.70920663e+00, -1.40035942e+00, -1.10050771e+00,
        -8.09651493e-01, -5.27790774e-01, -2.54925553e-01,
        8.94417172e-03, 2.63818399e-01, 5.09697128e-01,
        7.46580360e-01, 9.74468095e-01, 1.19336033e+00,
        1.40325707e+00, 1.60415831e+00, 1.79606406e+00,
        1.97897431e+00, 2.15288906e+00, 2.31780831e+00,
        2.47373207e+00, 2.62066033e+00, 2.75859309e+00,
        2.88753035e+00, 3.00747212e+00, 3.11841838e+00,
        3.22036916e+00, 3.31332443e+00, 3.39728421e+00,
        3.47224849e+00, 3.53821727e+00, 3.59519055e+00,
        3.64316834e+00, 3.68215063e+00, 3.71213742e+00,
        3.73312871e+00, 3.74512451e+00, 3.74812481e+00,
        3.74212961e+00, 3.72713892e+00, 3.70315273e+00,
        3.67017104e+00, 3.62819385e+00, 3.57722117e+00,
        3.51725299e+00, 3.44828931e+00, 3.37033013e+00,
        3.28337546e+00, 3.18742528e+00, 3.08247962e+00,
        2.96853845e+00, 2.84560179e+00, 2.71366963e+00,
        2.57274197e+00, 2.42281881e+00, 2.26390016e+00,
        2.09598601e+00, 1.91907636e+00, 1.73317122e+00,
        1.53827057e+00, 1.33437443e+00, 1.12148280e+00,
        8.99595662e-01, 6.68713030e-01, 4.28834900e-01,
        1.79961273e-01, -7.79078508e-02, -3.44772472e-01,
        -6.20632591e-01, -9.05488208e-01, -1.19933932e+00,
        -1.50218593e+00, -1.81402804e+00, -2.13486565e+00,
        -2.46469875e+00, -2.80352735e+00, -3.15135145e+00,
        -3.50817104e+00, -3.87398614e+00, -4.24879673e+00,
        -4.63260282e+00, -5.02540440e+00, -5.42720148e+00,
        -5.83799406e+00, -6.25778214e+00, -6.68656571e+00,
        -7.12434479e+00,
        1.82003494e+00, 1.70972980e+00, 1.60167577e+00,
        1.49587288e+00, 1.39232110e+00, 1.29102046e+00,
        1.19197094e+00, 1.09517254e+00, 1.00062527e+00,
        9.08329128e-01, 8.18284109e-01, 7.30490216e-01,
        6.44947448e-01, 5.61655805e-01, 4.80615288e-01,
        4.01825897e-01, 3.25287631e-01, 2.51000490e-01,
        1.78964475e-01, 1.09179585e-01, 4.16458212e-02,
        -2.36368175e-02, -8.66683307e-02, -1.47448718e-01,
        -2.05977981e-01, -2.62256118e-01, -3.16283129e-01,
        -3.68059015e-01, -4.17583775e-01, -4.64857410e-01,
        -5.09879920e-01, -5.52651303e-01, -5.93171562e-01,
        -6.31440695e-01, -6.67458703e-01, -7.01225585e-01,
        -7.32741341e-01, -7.62005972e-01, -7.89019478e-01,
        -8.13781858e-01, -8.36293113e-01, -8.56553242e-01,
        -8.74562246e-01, -8.90320124e-01, -9.03826877e-01,
        -9.15082505e-01, -9.24087006e-01, -9.30840383e-01,
        -9.35342634e-01, -9.37593759e-01, -9.37593759e-01,
        -9.35342634e-01, -9.30840383e-01, -9.24087006e-01,
        -9.15082505e-01, -9.03826877e-01, -8.90320124e-01,
        -8.74562246e-01, -8.56553242e-01, -8.36293113e-01,
        -8.13781858e-01, -7.89019478e-01, -7.62005972e-01,
        -7.32741341e-01, -7.01225585e-01, -6.67458703e-01,
        -6.31440695e-01, -5.93171562e-01, -5.52651303e-01,
        -5.09879920e-01, -4.64857410e-01, -4.17583775e-01,
        -3.68059015e-01, -3.16283129e-01, -2.62256118e-01,
        -2.05977981e-01, -1.47448718e-01, -8.66683307e-02,
        -2.36368175e-02, 4.16458212e-02, 1.09179585e-01,
        1.78964475e-01, 2.51000490e-01, 3.25287631e-01,
        4.01825897e-01, 4.80615288e-01, 5.61655805e-01,
        6.44947448e-01, 7.30490216e-01, 8.18284109e-01,
        9.08329128e-01, 1.00062527e+00, 1.09517254e+00,
        1.19197094e+00, 1.29102046e+00, 1.39232110e+00,
        1.49587288e+00, 1.60167577e+00, 1.70972980e+00,
        1.82003494e+00

};

/* Exported functions ------------------------------------------------------*/
/***
 * @brief Applies second order regression to the given vector. Given vector 
 * should be composed of 100 elements.
 *
 * @param samples: Pointer to the vector.
 * @param coefficients: Pointer to the second order return polynomial.
 */
void Polyreg_Fit(float *samples, float *coefficients)
{
    Matrix_t C, Y, A;
    C.arr = (float *)Deg2Sa100From1d8to2d2;
    C.m = CALIBRATION_POLY_DEGREE + 1;
    C.n = CALIBRATION_NUM_OF_SAMPLES;

    Y.arr = samples;
    Y.m = CALIBRATION_NUM_OF_SAMPLES;
    Y.n = 1;

    A.arr = coefficients;

    Matrix_Multiply(&C, &Y, &A);
}